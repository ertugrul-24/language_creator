# Phase 1.3: Create Language in Supabase - Implementation Guide

## Overview

P1.3 focuses on implementing the full language creation workflow with proper database integration, error handling, and preparation for future specs storage.

**Status:** Ready for implementation  
**Duration:** 1-2 days  
**Dependencies:** P1.1, P1.2 complete  

---

## Current Implementation Status

### ✅ Already Complete (P1.1-P1.2)

- Form captures language specs (alphabet, writing direction, phonemes, etc.)
- Form validation (minimum phonemes, required fields)
- Specs warning modals (depth level warning)
- UI tabbed interface (Basic Info | Language Specs)

### ⚠️ Phase 1.3 Tasks

1. **Specs Preparation** - Store specs metadata (NOT database storage yet)
2. **Language ID Generation** - Automatic via Supabase UUID
3. **Owner in Collaborators** - Already implemented, verify
4. **Stats Initialization** - Prepare but don't store yet
5. **Error Handling** - Improve backend error mapping
6. **Activity Logging** - Prepare for Phase 1.3+

---

## Database Operations

### Current Schema (Phase 1)

```sql
CREATE TABLE languages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID NOT NULL REFERENCES auth.users(id),
  name VARCHAR(50) NOT NULL,
  description TEXT NOT NULL,
  icon VARCHAR(10),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(owner_id, name)  -- One name per user
);

CREATE TABLE language_collaborators (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  language_id UUID NOT NULL REFERENCES languages(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  role VARCHAR(20) DEFAULT 'viewer',
  joined_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY (language_id, user_id)
);
```

### Phase 1.3 Schema Enhancement

No schema changes needed for Phase 1.3 - all data persists in existing tables.

### Phase 1.2+ Schema (Future)

```sql
-- Add JSONB columns for specs and stats storage
ALTER TABLE languages ADD COLUMN specs JSONB;
ALTER TABLE languages ADD COLUMN stats JSONB;
ALTER TABLE languages ADD COLUMN metadata JSONB;

-- Create index for spec queries
CREATE INDEX idx_languages_depth_level 
  ON languages USING gin (specs);
```

---

## Implementation Walkthrough

### Step 1: Verify Supabase Connection

File: `src/services/supabaseClient.ts`

✅ Already implemented. Verify:
- `VITE_SUPABASE_URL` environment variable
- `VITE_SUPABASE_ANON_KEY` environment variable
- Test connection: `npm run dev` should show no Supabase errors

### Step 2: Verify Language Creation Flow

File: `src/pages/NewLanguagePage.tsx`

Current flow:
```
1. User fills basic info (name, description, icon)
2. User fills specs (alphabet, phonemes, etc.)
3. User clicks "Create Language"
4. Both sections validate
5. createLanguage() is called with all data
```

✅ Already implemented. The form:
- Validates both sections before submission
- Calls `createLanguage(userId, input, specs)`
- Navigates to language detail page on success

### Step 3: Review Language Service

File: `src/services/languageService.ts`

The `createLanguage()` function now includes:

✅ **Validation**
```typescript
- User ID check
- Name required & length limits (2-50 chars)
- Description required & length limits (10-500 chars)
- Duplicate name check (per user)
```

✅ **Database Operations**
```typescript
- INSERT language record (auto-generates UUID)
- INSERT collaborator record (owner role)
- Returns complete language object
```

✅ **Error Handling**
```typescript
- Map Supabase errors (23505 = duplicate, 23502 = required field)
- User-friendly error messages
- Detailed logging for debugging
```

✅ **Prepared for Future (Phase 1.2+)**
```typescript
- Stats initialized (totalWords, totalRules, etc.)
- Activity logging prepared
- Specs parameter accepted (not stored yet)
```

### Step 4: Test the Flow

**Manual Testing:**

1. Start dev server:
   ```bash
   npm run dev
   ```

2. Navigate to Create Language:
   - Click "Create Language" or go to `/create-language`

3. Fill form:
   - Name: "Test Language"
   - Description: "A test constructed language for P1.3"
   - Icon: Select one
   - Specs: Add at least 5 phonemes
   - Word Order: SVO
   - etc.

4. Submit:
   - Should see loading spinner
   - Should redirect to language detail page
   - Check browser console for logs

5. Verify database:
   - Check Supabase dashboard
   - Language should appear in `languages` table
   - User should be in `language_collaborators` table with role='owner'

**Expected Results:**

```
✅ Language record created with:
   - id: UUID (auto-generated)
   - owner_id: current user ID
   - name: entered name
   - description: entered description
   - icon: selected emoji
   - created_at: current timestamp
   - updated_at: current timestamp

✅ Collaborator record created with:
   - language_id: created language ID
   - user_id: current user ID
   - role: 'owner'
   - joined_at: current timestamp

✅ No errors in console
✅ Redirect to /languages/{languageId} succeeds
```

---

## Error Scenarios to Handle

### 1. Duplicate Language Name

**Error:** User tries to create two languages with same name

```typescript
// Current implementation:
"You already have a language with this name"

// Supabase returns 23505 (unique violation)
// Our code maps this to user-friendly message
// ✅ Already implemented
```

### 2. Missing User ID

**Error:** User not authenticated

```typescript
// Current implementation:
"User ID is required"

// Supabase would reject with 403 forbidden
// ✅ Already validated client-side
```

### 3. Database Connection Failure

**Error:** Supabase unreachable

```typescript
// Current implementation:
"Failed to create language: [error message]"

// Should retry or show helpful message
// ✅ Error logged for debugging
```

### 4. Collaborator Insert Fails (after language created)

**Error:** Language created but collaborator not added

```typescript
// Current implementation:
Continues with warning, user can recover
"Warning: Could not add user as collaborator, but language was created"

// This is acceptable for Phase 1
// ✅ Already handled gracefully
```

---

## Future Extensions (Phase 1.4+)

### 1. Store Specs in Database

Currently, specs are captured but not stored. Phase 1.2+ will add:

```typescript
// In createLanguage():
const languageData = {
  owner_id: userId,
  name: input.name.trim(),
  description: input.description.trim(),
  icon: input.icon,
  specs: specs || null,           // ← NEW (Phase 1.2+)
  stats: initializeLanguageStats(), // ← NEW (Phase 1.2+)
  metadata: initializeLanguageMetadata(), // ← NEW (Phase 1.2+)
};
```

### 2. Initialize Language Stats

Stats to track language development:

```typescript
{
  totalWords: 0,           // Words in dictionary
  totalRules: 0,           // Grammar rules
  totalContributors: 1,    // Collaborators
  lastModified: timestamp, // For sorting
}
```

### 3. Activity Logging

Create activity entry when language is created:

```typescript
{
  type: "language_created",
  description: "Created language: Elvish",
  languageId: "...",
  timestamp: "...",
  visibility: "public|private", // Based on user settings
}
```

### 4. Firebase Support

Implement same functions for Firebase (Phase 1.4+):

```typescript
// Same function signatures
export const createLanguage = async (
  userId: string,
  input: CreateLanguageInput,
  specs?: Partial<LanguageSpecs>
): Promise<Language>

// Different backend (Firestore instead of PostgreSQL)
// Same business logic
// Same error handling
```

---

## Testing Checklist

- [ ] Dev server starts without errors
- [ ] Login/signup works
- [ ] Navigate to Create Language page
- [ ] Fill and submit form with valid data
- [ ] Language appears in Supabase dashboard
- [ ] Collaborator record created correctly
- [ ] Redirect to language detail page works
- [ ] Create multiple languages for same user
- [ ] Try duplicate language name (should error)
- [ ] Try invalid data (should show validation errors)
- [ ] Check browser console for logs
- [ ] Verify Supabase dashboard entries match form data

---

## Code References

### Files Modified
- `src/services/languageService.ts` - Enhanced with dual-backend documentation
- `docs/BACKEND_ARCHITECTURE.md` - New comprehensive guide

### Files to Review
- `src/pages/NewLanguagePage.tsx` - Form that calls createLanguage()
- `src/components/LanguageSpecsForm.tsx` - Specs form component
- `src/services/supabaseClient.ts` - Supabase connection

### Related Files (for future phases)
- `docs/FIREBASE_ADAPTER_TEMPLATE.md` - Firebase implementation template
- `src/types/database.ts` - Database type definitions

---

## Success Criteria

✅ User can create language with basic info  
✅ Language saved to Supabase with correct data  
✅ User automatically added as owner/collaborator  
✅ Error messages are user-friendly  
✅ No TypeScript errors  
✅ Console logs are clear and helpful  
✅ Redirect to detail page works  
✅ Specs captured but not stored (Phase 1.2+ will store)  

---

## Next Steps (After P1.3)

1. **P1.4:** Build language dashboard/detail page
   - Display language info
   - Show stats and specs
   - Tabs for Dictionary, Rules, Courses

2. **P1.5:** Build languages list page
   - Show user's languages
   - Filter and sort
   - Quick actions

3. **P1.2-Phase2+:** Store specs in database
   - Add JSONB columns
   - Update createLanguage to save specs
   - Create specs detail view

4. **P1.4+:** Firebase adapter
   - Implement same functions for Firebase
   - Create adapter pattern
   - Test both backends

---

## Questions & Troubleshooting

**Q: Why store specs but not save them?**
A: Phase 1 focuses on basic creation. Phase 1.2+ will add specs storage in database schema.

**Q: How do I add specs to database?**
A: In Phase 1.2+, add JSONB columns and update createLanguage() to store specs parameter.

**Q: How do I support Firebase?**
A: Create firebaseLanguageService.ts with identical function signatures. See FIREBASE_ADAPTER_TEMPLATE.md.

**Q: Are there any breaking changes?**
A: No. P1.3 enhancement is backward compatible. Existing createLanguage() signature extended only.

**Q: How are errors logged?**
A: All database operations log to browser console with [functionName] prefix. Check DevTools Console.

---

**Ready to implement? Start with testing the current flow, then enhance as described above.**
